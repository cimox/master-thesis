<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streaming tree</title>
    <style>

        .node circle {
            stroke: black;
            stroke-width: 3.5px;
        }

        .node text {
            color: black;
        }

        .link {
            fill: none;
            stroke: red;
            stroke-width: 2.5px;
        }
    </style>
    <!--Libraries imports-->
    <script type="text/javascript" src="lib/d3_v3.js"></script>
    <script type="text/javascript" src="lib/lodash.min.js"></script>
    <script type="text/javascript" src="lib/async.min.js"></script>
    <script type="text/javascript" src="lib/loglevel.min.js"></script>
    <!--My scripts imports-->
    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/tree.js"></script>
</head>
<body>
<script>
    /* Initialization - START */
    var width = 800,
        height = 800;

    var tree = d3.layout.tree()
        .size([width - 20, height - 20]);

    var root = {};
    tree(root);

    root.parent = root;
    root.px = root.x;
    root.py = root.y;

    var diagonal = d3.svg.diagonal();

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(10,10)");

    var duration = 750;
    log.setLevel("debug");
    /* Initialization - END */

    function addTreeIncrement(treeIncrement) {
        log.debug('Trying to add increment ' + treeIncrement.id + ' to tree');

        // Add a new node to its parent if exists.
        if (!root.children || root.children.length <= 0) {
            addChildren(root, treeIncrement);
        }
        else if (getTreeNode(root, treeIncrement.id).id == treeIncrement.id && treeIncrement.id != "root") {
            log.debug('UPDATE node ' + treeIncrement.id);
            var nodeToUpdate = getTreeNode(root, treeIncrement.id);
            updateNodeData(nodeToUpdate, treeIncrement);
            updateTree();
        }
        else if (treeIncrement.id != "root") {
            log.debug('ADD increment ' + treeIncrement.id + ' -> ' + treeIncrement.parent);
            addChildren(getTreeNode(root, treeIncrement.parent), treeIncrement);
        }

        // Get node and link values.
        var nodes = tree.nodes(root).reverse(),
            links = tree.links(nodes);

        var node = svg.selectAll("g.node")
            .data(nodes, function (d) {
                return d.id;
            });
        var link = svg.selectAll(".link")
            .data(links, function (d) {
                return d.source.id + "-" + d.target.id;
            });

        // Render node labels and links between them.
        renderLabels(node);
        renderLinks(link, svg);
    }

    d3.json("data/first.json", function (error, treeData) {
        if (error) throw error;

        BFT(treeData, addTreeIncrement).then((complete) => {
            log.info('Result: ' + complete);
        });
    });

    function addIncrement(filename) {
        d3.json(filename, function (error, treeData) {
            if (error) throw error;

            BFT(treeData, addTreeIncrement).then((complete) => {
                log.info('Add increment result: ' + complete);

                setTimeout(() => {
                    removeOldNodes(treeData, root);
                }, 1000);
            });
        });
    }

    function removeNodeBtn() {
        console.log('Removing node');

        root.children.splice(1, 1);

        updateTree();
    }

    function updateBtn() {
        updateTree();
    }

</script>

<div class="control-group">
    <button onclick="addIncrement('data/first-simple.json')">Add simple increment</button>
    <button onclick="addIncrement('data/second.json')">Add second increment</button>
    <button onclick="addIncrement('data/third.json')">Add third increment</button>
    <button onclick="addIncrement('data/fourth.json')">Add fourth increment</button>

    <button onclick="removeNodeBtn()">Remove node</button>
    <button onclick="updateBtn()">update</button>
</div>

</body>
</html>