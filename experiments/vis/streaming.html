<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streaming tree</title>
    <!--Libraries imports-->
    <script type="text/javascript" src="lib/d3_v3.js"></script>
    <script type="text/javascript" src="lib/lodash.min.js"></script>
    <script type="text/javascript" src="lib/loglevel.min.js"></script>
    <script type="text/javascript" src="lib/jquery-3.2.0.min.js"></script>
    <script type="text/javascript" src="lib/notify.min.js"></script>

    <!--My scripts imports-->
    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/tree.js"></script>

    <!--Styles-->
    <link rel="stylesheet" type="text/css" href="css/styles.css">
</head>
<body>
<script>
    /* Initialization - START */
    let API_STREAM = 'http://localhost:8080/stream/';

    let width = 1200,
        height = 750;

    let tree = d3.layout.tree()
        .size([width - 20, height - 50]);

    let root = {};
    tree(root);

    root.parent = root;
    root.px = root.x;
    root.py = root.y;

    let diagonal = d3.svg.diagonal();

    let svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(10,10)");

    let duration = 550, fadeDuration = 850;
    let animationsFinished = true, processNextMessage = true, removalFinished = true;

    log.setLevel("info");
    /* Initialization - END */

    function addIncrementBtn(filename) {
        d3.json(filename, function (error, treeData) {
            if (error) throw error;

            if (animationsFinished) {
                log.info('Adding ' + filename + ', increment.');
                BFT(treeData, addTreeIncrement).then((complete) => {
                    log.info('Add increment result: ' + complete);

                    setTimeout(() => {
                        removeAndFadeOutOldNodes(treeData, root);
                    }, 1000);
                });
            }
        });
    }

    function removeNodeBtn() {
        console.log('Removing node');

        root.children.splice(1, 1);

        updateTree();
    }

    let eventStream;
    function readTreeStream() {
        if (eventStream === undefined) {
            eventStream = new EventSource(API_STREAM);
        }
        else {
            log.warn('EventStream was already opened!');
        }

        eventStream.addEventListener('tree', function (response) {
            let responseData = JSON.parse(response.data);

            if (animationsFinished && processNextMessage && removalFinished) {
                log.debug('Processing message ' + responseData + ' from stream ');
                animationsFinished = processNextMessage = removalFinished = false;
                linkMaxWidth = responseData['maxInstancesSeen'];
                linkMinWidth = responseData['minInstancesSeen'];

                BFT(responseData, addTreeIncrement).then((complete) => {
                    if (_.isEqual(complete, "success")) {
                        log.info('Tree successfully processed');
                        processNextMessage = true;
                    }
                    removeAndFadeOutOldNodes(responseData, root);
                });
            }
        });

        eventStream.addEventListener('notification', function (response) {

        });
    }

    function onlineBtn() {
        log.info('EventStream opened');
        readTreeStream();
    }

    function stopBtn() {
        eventStream.close();
        eventStream = undefined;

        log.info('EventStreams closed');
    }

</script>

<div class="control-group">
    <button onclick="addIncrementBtn('data/first.json')">Add first increment</button>
    <button onclick="addIncrementBtn('data/second.json')">Add second increment</button>
    <button onclick="addIncrementBtn('data/third.json')">Add third increment</button>
    <button onclick="addIncrementBtn('data/fourth.json')">Add fourth increment</button>

    <button onclick="removeNodeBtn()">Remove node</button>
    <button onclick="updateBtn()">update</button>

    <button onclick="onlineBtn()">Online</button>
    <button onclick="stopBtn()">STOP</button>
</div>

</body>
</html>