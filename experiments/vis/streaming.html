<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streaming tree</title>
    <style>

        .node {
            stroke: #fff;
            stroke-width: 2px;
        }

        .link {
            fill: none;
            stroke: #000;
        }
    </style>
    <script type="text/javascript" src="lib/d3_v3.js"></script>
    <script type="text/javascript" src="lib/lodash.min.js"></script>
</head>
<body>
<script>

    var width = 900,
        height = 900;

    var tree = d3.layout.tree()
        .size([width - 20, height - 20]);

    var root = {},
        nodes = tree(root);

    var nodeIdsLookup = {}, nodePosition = 0;

    root.parent = root;
    root.px = height / 2;
    root.py = 0;

    var diagonal = d3.svg.diagonal()
        .projection(function (d) { return [d.y, d.x] });

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(10,10)");

    var node = svg.selectAll(".node"),
        link = svg.selectAll(".link");

    var duration = 750;

    function update(treeIncrement) {
        function addChildren(parentNode, element) {
            if (parentNode.children) {
                console.log('Adding node ' + element.id + " to parent " + parentNode.id);
                newNode = _.cloneDeep(element);
                newNode['children'] = [];

                parentNode.children.push(newNode);
                nodes.push(newNode);
                nodeIdsLookup[newNode.id] = nodePosition++;
            }
            else {
                parentNode.id = "root";
                parentNode.children = [];
                parentNode.leaf = false;
                nodeIdsLookup["root"] = nodePosition++;
            }
        }

        function getParentNode(nodeID) {
            return nodes[nodeIdsLookup[nodeID]];
        }

        // Add a new node to its parent if exists.
        if (nodes.length == 1) {
            var parentNode = nodes[0];
            addChildren(parentNode, treeIncrement);
        }
        else {
            console.log('Adding ' + treeIncrement.id + ' to parent ' + treeIncrement.parent);
            addChildren(getParentNode(treeIncrement.parent), treeIncrement);
        }

        // Recompute the layout and data join.
        node = node.data(tree.nodes(root), function (d) {
            return d.id;
        });
        link = link.data(tree.links(nodes), function (d) {
            return d.source.id + "-" + d.target.id;
        });

        // Add entering nodes in the parent’s old position.
        node.enter().append("circle")
            .attr("class", "node")
            .attr("r", 6.5)
            .attr("cx", function (d) {
                return d.parent.py;
            })
            .attr("cy", function (d) {
                return d.parent.px;
            });

        // Add entering links in the parent’s old position.
        link.enter().insert("path", ".node")
            .attr("class", "link")
            .attr("d", function (d) {
                var o = {
                    x: d.source.px,
                    y: d.source.py
                };
                return diagonal({source: o, target: o});
            });
//            .attr("stroke-width", function () {
//                return Math.random() * 5
//            });

        // Transition nodes and links to their new positions.
        var t = svg.transition()
            .duration(duration);

        t.selectAll(".link")
            .attr("d", diagonal);

        t.selectAll(".node")
            .attr("cx", function (d) {
                return d.py = d.y;
            })
            .attr("cy", function (d) {
                return d.px = d.x;
            });
    }

    var timeout = 1000;
    function bft(tree, callback) {
        var queue = [];

        queue.push(tree);
        while (queue.length !== 0) {
            var element = queue.shift();
            function renderElement(element, timeout) {
                (function () {
                    setTimeout(function () {
                        callback(element);
                    }, timeout);
                })();
            }
            renderElement(element, timeout);
            timeout += 1000;

            if (element.children !== undefined) {
                for (var i = 0; i < element.children.length; i++) {
                    queue.push(element.children[i]);
                }
            }
        }
    }

    d3.json("data/first.json", function (error, treeData) {
        if (error) throw error;

        bft(treeData, update);
    });

    function addTreeIncrement() {
        d3.json("data/second.json", function (error, treeData) {
            if (error) throw error;

            update(treeData);
        });
    }

</script>

<div class="control-group">
    <button onclick="addTreeIncrement()">Add increment</button>
</div>

</body>
</html>