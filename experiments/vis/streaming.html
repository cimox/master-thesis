<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Streaming tree</title>
    <style>

        .node {
            stroke: #fff;
            stroke-width: 2px;
        }

        .link {
            fill: none;
            stroke: #000;
        }
    </style>
    <script type="text/javascript" src="lib/d3_v3.js"></script>
    <script type="text/javascript" src="lib/lodash.min.js"></script>
    <script type="text/javascript" src="js/utils.js"></script>
    <script type="text/javascript" src="js/tree.js"></script>
</head>
<body>
<script>

    var width = 900,
        height = 900;

    var tree = d3.layout.tree()
        .size([width - 20, height - 20]);

    var root = {},
        nodes = tree(root);

    var nodeIdsLookup = {}, nodePosition = 0;

    root.parent = root;
    root.px = root.x;
    root.py = root.y;

    var diagonal = d3.svg.diagonal();
    //        .projection(function (d) { return [d.y, d.x] });

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(10,10)");

    var node = svg.selectAll(".node"),
        link = svg.selectAll(".link");

    var duration = 750;

    function addTreeIncrement(treeIncrement) {
        // Add a new node to its parent if exists.
        if (nodes.length == 1) {
            var parentNode = nodes[0];
            addChildren(parentNode, treeIncrement);
        }
//        else if (getParentNode(treeIncrement.id) && treeIncrement.id != "root") {
////            TODO: fix this nodes lookup table
//            console.log('Updating data of existing node ' + treeIncrement.id);
//            var nodeToUpdate = nodes[nodeIdsLookup[treeIncrement.id]];
//            updateNodeData(nodeToUpdate, treeIncrement);
//        }
        else if (treeIncrement.id != "root") {
            addChildren(getParentNode(treeIncrement.parent), treeIncrement);
        }

        // Recompute the layout and data join.
        node = node.data(tree.nodes(root), function (d) {
            return d.id;
        });
        link = link.data(tree.links(nodes), function (d) {
            return d.source.id + "-" + d.target.id;
        });

        var nodeEnter = node.enter();

        // Add entering nodes in the parent’s old position.
        nodeEnter.append("circle")
            .attr("class", "node")
            .attr("r", 6.5)
            .attr("cx", function (d) {
                return d.parent.px;
            })
            .attr("cy", function (d) {
                return d.parent.py;
            })
            .style("fill", function (d) {
                return d.leaf ? "red" : "blue";
            });

//        var nodeUpdate = node.transition()
//            .attr("transform", function (d) {
//                return "translate(" + d.x + "," + d.y + ")";
//            });
//
//        nodeUpdate.select("circle")
//            .style("fill", function (d) {
//                console.log('Updating style of node ' + d.id);
//                return d.leaf ? "red" : "blue";
//            });

        // Add entering links in the parent’s old position.
        link.enter().insert("path", ".node")
            .attr("class", "link")
            .attr("d", function (d) {
                var o = {
                    x: d.source.px,
                    y: d.source.py
                };
                return diagonal({source: o, target: o});
            });

        // Transition nodes and links to their new positions.
        var t = svg.transition()
            .duration(duration);

        t.selectAll(".link")
            .attr("d", diagonal);

        t.selectAll(".node")
            .attr("cx", function (d) {
                return d.px = d.x;
            })
            .attr("cy", function (d) {
                return d.py = d.y;
            });
    }

    function updateTree() {
        console.log('Updating tree');

        // Compute the new tree layout.
        var nodes = tree.nodes(root).reverse(),
            links = tree.links(nodes);

        var node = svg.selectAll("circle.node")
            .data(nodes, function (d) {
                return d.id || (d.id = ++i);
            });
        node.exit().remove();

        var link = svg.selectAll("path.link")
            .data(links, function (d) {
                return d.target.id;
            });
        link.exit().remove();

        var t = svg.transition()
            .duration(duration);

        t.selectAll(".link")
            .attr("d", diagonal);

        t.selectAll(".node")
            .attr("cx", function (d) {
                return d.px = d.x;
            })
            .attr("cy", function (d) {
                return d.py = d.y;
            });
    }

    function bft(tree, callback) {
        var timeout = 750;
        var queue = [];

        queue.push(tree);
        while (queue.length !== 0) {
            var element = queue.shift();
//            console.log('Processing element ' + element.id);
            function renderElement(element, timeout) {
                (function () {
                    setTimeout(function () {
                        callback(element);
                    }, timeout);
                })();
            }

            renderElement(element, timeout);
            timeout += 750;

            if (element.children !== undefined) {
                for (var i = 0; i < element.children.length; i++) {
                    queue.push(element.children[i]);
                }
            }
        }
    }

    d3.json("data/second.json", function (error, treeData) {
        if (error) throw error;

        bft(treeData, addTreeIncrement);
    });

    function addIncrement() {
        d3.json("data/b.json", function (error, treeData) {
            if (error) throw error;

            bft(treeData, addTreeIncrement);
        });
    }

    function removeNodeBtn() {
        console.log('Removing node');

        root.children.splice(1, 1);

        updateTree();
    }

</script>

<div class="control-group">
    <button onclick="addTreeIncrement()">Add increment</button>
    <button onclick="addIncrement()">Add increment</button>
    <button onclick="removeNodeBtn()">Remove node</button>
</div>

</body>
</html>